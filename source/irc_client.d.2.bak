// source/irc_client.d
module irc_client;

import std.socket;
import std.string;
import std.stdio;
import std.concurrency;
import std.conv;
import core.time;
import models;
import logging;

void runIrcServer(string server, Tid parentTid) {
    logToTerminal("Connecting to IRC server: " ~ server, "INFO", "irc");
    auto addrInfo = getAddress(server, 6667);
    if (addrInfo.length == 0) {
        logToTerminal("Failed to resolve server: " ~ server, "ERROR", "irc");
        return;
    }

    auto socket = new TcpSocket();
    socket.connect(addrInfo[0]);
    logToTerminal("Connected to " ~ server, "INFO", "irc");

    socket.send("NICK " ~ DEFAULT_NICK ~ "\r\n");
    socket.send("USER " ~ DEFAULT_NICK ~ " 0 * :Pike IRC Client\r\n");

    char[1024] buffer;
    while (true) {
        auto received = socket.receive(buffer);
        if (received <= 0) {
            logToTerminal("Connection closed by server", "ERROR", "irc");
            send(parentTid, IRCMessage(IRCMessage.Type.UpdateChannels, server, "", "failed"));
            break;
        }

        string message = buffer[0 .. received].idup.strip;
        logToTerminal("Received: " ~ message, "INFO", "irc");

        // Handle MOTD (numeric codes 375, 372, 376)
        if (message.startsWith(":")) {
            auto parts = message.split(" ");
            if (parts.length >= 2) {
                string command = parts[1];
                if (command == "375" || command == "372" || command == "376") {
                    // MOTD message
                    string motdText = parts.length >= 4 ? parts[3 .. $].join(" ").stripPrefix(":") : "MOTD";
                    send(parentTid, IRCMessage(IRCMessage.Type.Message, server, motdText));
                }
            }
        }

        // Handle PING
        if (message.startsWith("PING ")) {
            string pong = "PONG " ~ message[5 .. $] ~ "\r\n";
            socket.send(pong);
            logToTerminal("Sent: " ~ pong.strip, "INFO", "irc");
        }

        // Handle channel messages
        if (message.contains(" PRIVMSG ")) {
            auto parts = message.split(" ");
            if (parts.length >= 4) {
                string channel = parts[2];
                string text = parts[3 .. $].join(" ").stripPrefix(":");
                send(parentTid, IRCMessage(IRCMessage.Type.Message, channel, text));
            }
        }

        // Handle JOIN/PART
        if (message.contains(" JOIN ")) {
            auto parts = message.split(" ");
            if (parts.length >= 3) {
                string channel = parts[2].stripPrefix(":");
                send(parentTid, IRCMessage(IRCMessage.Type.UpdateChannels, channel, "", "join"));
            }
        } else if (message.contains(" PART ")) {
            auto parts = message.split(" ");
            if (parts.length >= 3) {
                string channel = parts[2];
                send(parentTid, IRCMessage(IRCMessage.Type.UpdateChannels, channel, "", "part"));
            }
        }

        // Handle commands from GUI
        receiveTimeout(Duration.zero,
            (IRCMessage msg) {
                if (msg.type == IRCMessage.Type.Message) {
                    socket.send("PRIVMSG " ~ msg.channel ~ " :" ~ msg.text ~ "\r\n");
                    logToTerminal("Sent to " ~ msg.channel ~ ": " ~ msg.text, "INFO", "irc");
                } else if (msg.type == IRCMessage.Type.UpdateChannels) {
                    if (msg.action == "join") {
                        socket.send("JOIN " ~ msg.channel ~ "\r\n");
                        logToTerminal("Joining channel: " ~ msg.channel, "INFO", "irc");
                    } else if (msg.action == "part") {
                        socket.send("PART " ~ msg.channel ~ "\r\n");
                        logToTerminal("Parting channel: " ~ msg.channel, "INFO", "irc");
                    }
                }
            }
        );
    }
}
