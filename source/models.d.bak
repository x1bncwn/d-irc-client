// source/models.d
module models;

immutable string defaultChannel = "#pike-test";
immutable string defaultServer = "irc.deft.com";
immutable ushort defaultPort = 6667;
immutable string defaultNick = "dlangIRC";

/// Types of messages sent from the IRC thread to the GTK thread
enum IrcToGtkType {
    chatMessage,
    channelUpdate,
    systemMessage,
    channelTopic,
    whoisReply  // Added for WHOIS replies
}

/// Structured chat message with separate raw nick and prefix
struct ChatMessage {
    string server;
    string channel;      // Empty string for server tab or query
    string timestamp;    // e.g. "[15:28]"
    string rawNick;      // Nick without any prefix
    string prefix;       // Single character ("@", "+", "%", "~", "&") or empty string
    string messageType;  // "message", "action", "notice", "join", "part", "quit", "kick", "nick", "system"
    string body;
}

/// Channel join/part/failed update
struct ChannelUpdate {
    string server;
    string channel;
    string action;       // "join", "part", "failed"
}

/// Channel topic update
struct ChannelTopic {
    string server;
    string channel;
    string topic;
}

/// WHOIS reply data - accumulates all WHOIS information
struct WhoIsReply {
    string server;
    string target;       // Nickname being WHOIS'd
    string user;         // From 311: username
    string host;         // From 311: hostname
    string realname;     // From 311: real name
    string serverInfo;   // From 312: server info
    string[] channels;   // From 319: channels
    bool isOperator;     // From 313: is operator
    bool isRegistered;   // From 307: registered nick
    bool isHelpOp;       // From 310: help operator
    bool isAway;         // From 301: away status
    string awayMessage;  // From 301: away message
    string loggedInAs;   // From 330: logged in as
    string actualHost;   // From 338: actual host
    string idleTime;     // From 317: idle time formatted
    string signonTime;   // From 317: signon time formatted
    string secureInfo;   // From 671: secure connection info
    string hostInfo;     // From 378: host info
    string modesInfo;    // From 379: modes info
    string specialInfo;  // From 320: special info
    
    // Constructor
    this(string server, string target) {
        this.server = server;
        this.target = target;
        this.channels = [];
    }
    
    // Helper to check if we have basic info (311 reply received)
    bool hasBasicInfo() {
        return user.length > 0 && host.length > 0;
    }
    
    // Format the WHOIS reply as a string for display
    string format() {
        string result = "--- WHOIS for " ~ target ~ " ---\n";
        
        if (hasBasicInfo()) {
            result ~= target ~ " [" ~ user ~ "@" ~ host ~ "] " ~ realname ~ "\n";
        }
        
        if (serverInfo.length > 0) {
            result ~= "Using server: " ~ serverInfo ~ "\n";
        }
        
        if (channels.length > 0) {
            result ~= "Channels: " ~ channels.join(" ") ~ "\n";
        }
        
        if (idleTime.length > 0) {
            result ~= "Idle: " ~ idleTime ~ "\n";
        }
        
        if (signonTime.length > 0) {
            result ~= "Signed on: " ~ signonTime ~ "\n";
        }
        
        if (isOperator) {
            result ~= "This user is an IRC operator\n";
        }
        
        if (isRegistered) {
            result ~= "Registered nickname\n";
        }
        
        if (isHelpOp) {
            result ~= "Available for help\n";
        }
        
        if (isAway && awayMessage.length > 0) {
            result ~= "Away: " ~ awayMessage ~ "\n";
        }
        
        if (loggedInAs.length > 0) {
            result ~= "Logged in as: " ~ loggedInAs ~ "\n";
        }
        
        if (actualHost.length > 0) {
            result ~= "Actually: " ~ actualHost ~ "\n";
        }
        
        if (secureInfo.length > 0) {
            result ~= target ~ " " ~ secureInfo ~ "\n";
        }
        
        if (hostInfo.length > 0) {
            result ~= "Host info: " ~ hostInfo ~ "\n";
        }
        
        if (modesInfo.length > 0) {
            result ~= "Modes: " ~ modesInfo ~ "\n";
        }
        
        if (specialInfo.length > 0) {
            result ~= "Special: " ~ specialInfo ~ "\n";
        }
        
        result ~= "--- End of WHOIS ---";
        return result;
    }
}

/// Union of all messages sent to GTK
struct IrcToGtkMessage {
    IrcToGtkType type;
    
    union {
        ChatMessage chat;
        ChannelUpdate channelUpdate;
        ChannelTopic topicData;
        WhoIsReply whoisData;  // Added for WHOIS replies
        string systemText;
    }
    
    // Factory methods
    static IrcToGtkMessage fromChat(ChatMessage c) {
        IrcToGtkMessage m;
        m.type = IrcToGtkType.chatMessage;
        m.chat = c;
        return m;
    }
    
    static IrcToGtkMessage fromUpdate(ChannelUpdate u) {
        IrcToGtkMessage m;
        m.type = IrcToGtkType.channelUpdate;
        m.channelUpdate = u;
        return m;
    }
    
    static IrcToGtkMessage fromSystem(string text) {
        IrcToGtkMessage m;
        m.type = IrcToGtkType.systemMessage;
        m.systemText = text;
        return m;
    }
    
    static IrcToGtkMessage fromTopic(ChannelTopic t) {
        IrcToGtkMessage m;
        m.type = IrcToGtkType.channelTopic;
        m.topicData = t;
        return m;
    }
    
    static IrcToGtkMessage fromWhois(WhoIsReply w) {
        IrcToGtkMessage m;
        m.type = IrcToGtkType.whoisReply;
        m.whoisData = w;
        return m;
    }
}

/// Messages from GTK to IRC thread (commands the user typed)
struct IrcFromGtkMessage {
    enum Type {
        Message,
        UpdateChannels,
        channelTopic
    }
    
    Type type;
    string channel;  // target channel or nick for PRIVMSG, or channel for join/part
    string text;     // message text or raw command
    string action;   // "join", "part", "quit" for UpdateChannels
}
